<!doctype html>
<html lang="en-us">

<head>
  <meta name="Description" content="A webassembly version of imagemagick that can crop comics into webtoon or tapas format.">
  <link rel="manifest" href="manifest.json">
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=.7">
  <!-- <link rel="icon" href="favicon.png"> -->

  <title>zinebot.wasm</title>

  <!-- download dependencies to zip and download files -->
  <script DEFER src="https://cdn.jsdelivr.net/g/filesaver.js"></script>
  <script DEFER src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
</head>

<style>
    textarea { display: block; }
    img { border: 1px solid black; box-shadow: 10px 10px 0 black; margin-top: 25px; }
</style> 

<body>
    <h1>ZineBot + Wasm?</h1>
    <input type=file name=file id="user-files" aria-label="File Input" accept=".jpg,.jpeg,.png" multiple>
    <textarea cols="50" id="text-area">-resize 400 -monochrome</textarea>
    <button id="go-button">go! go! go!</button>
    <div id="images-div"></div>
</body>

<script type='module'>
    // Import Image Magick... [tested]
    import * as Magick from 'https://knicknic.github.io/wasm-imagemagick/magickApi.js';

    // Access DOM elements...
    const userFiles = document.getElementById("user-files");
    const imageDiv = document.getElementById("images-div");
    const textArea = document.getElementById("text-area");
    const goButton = document.getElementById("go-button");


    // Function for reading user uploads... [tested]
    const readFile = file => {
        let readFile = Magick.CreatePromiseEvent();
        let fileReader = new FileReader();
        fileReader.onload = text => {
            const fileName = file.name
            const encodedText = text.target.result;
            const content = new Uint8Array(encodedText);
            const sourFileName = fileName;

            readFile['resolve']([sourFileName, content]);
        }
        fileReader.readAsArrayBuffer(file);
        return readFile;
    }


    // Working for joining multiple images...
    const processFiles2 = async () => {
        const files = userFiles.files;
        // const [fileName, content] = await readFile(files[0]);
        // const [fileName2, content2] = await readFile(files[1]);
        
        
        const readFilesArray = [];
        for (let i = 0; i < files.length; i++) {
            // console.log("------------> ", file)
            const file = await readFile(files[i]);
            readFilesArray.push(file);
        }
        console.log(readFilesArray.map(e => e));
        // const [fileName, content] = readFilesArray[0];
        // const [fileName2, content2] = readFilesArray[1];

        const magickInputs = readFilesArray.map(file => ({ 
            name: file[0],
            content: file[1] 
        }));

        console.log(magickInputs);
        imageDiv.innerHTML = '';

        const magickOutput = await Magick.execute({
            inputFiles: [ ...magickInputs ], 
            commands: `convert ${ magickInputs.map(f => f.name).join(" " + textArea.value + " ") + " " + textArea.value } +append ${textArea.value} output.png`
        })

        const file = magickOutput.results[0].outputFiles[0];
        // console.log(file)

        const imageBlob = new Blob([file.buffer]);
        const imageEle = document.createElement('img');
        imageEle.src = URL.createObjectURL(imageBlob);
        imageEle.name = file['name'];
        imageEle.wasmResponse = file;
        imageDiv.appendChild(imageEle);
    }
    

    // Working but cant access multiple images...
    const processFiles1 = async () => {
        const files = userFiles.files;
        const filesLength = files.length;
        const userStyling = textArea.value.split(" ");
        const processedImages = [];

        if (filesLength > 0) {
            imageDiv.innerHTML = '';
            for (let i = 0; i < files.length; i++) {
                const [fileName, content] = await readFile(files[i]);
                const fileNameNoType = fileName.substring(0, fileName.lastIndexOf('.'));
                const destFileName = fileNameNoType + '-%d.png';

                let splitFiles = await Magick.Call(
                    [{name: fileName, content: content}],
                    ["convert", fileName, ...userStyling, destFileName]
                );

                processedImages.push(...splitFiles);
            }
        }

        // Add images to page...
        for (let i = 0; i < processedImages.length; i++) {
            const file = processedImages[i];
            const imageBlob = file['blob'];
            const imageEle = document.createElement('img');
            imageEle.src = URL.createObjectURL(imageBlob);
            imageEle.name = file['name'];
            imageEle.wasmResponse = file;
            imageDiv.appendChild(imageEle);
        }
    }

    // Add listener to go button...
    goButton.addEventListener("click", event => {
        event.preventDefault();
        processFiles2();
    }, false);

</script>
</html>